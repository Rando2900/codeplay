<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="stylesheets/comunidad.css">
    <title>Comunidad</title>
</head>
<body>
<!-- Contenido principal de la p√°gina -->
<div id="main-content">
    <header class="header">
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="comunidad.html">Comunidad</a>
        <a href="juegos.html">Juegos</a>
        <a href="formulario.html">Crear</a>
      </nav>
      <div class="logo">
        <a href="index.html"><img src="images/CodePlay_ejemplo_sin_fondo (1).png" alt="Logo del Proyecto" /></a>
      </div>
      <div id="userMenu" class="buttons">
        <a href="login.html"><button>Iniciar Sesi√≥n</button></a>
        <a href="resgistro.html"><button>Registrarse</button></a>
      </div>
    </header>

    <main>
        <section class="projects-section">
            <h1>Proyectos de la Comunidad</h1>
            <div class="project-grid" id="projects-container">
                <!-- Los proyectos ser√°n cargados aqu√≠ din√°micamente -->
                <p>Cargando proyectos...</p>
            </div>
        </section>
    </main>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Acerca de Nosotros</h4>
          <p>Codeplay es una plataforma dise√±ada para creativos, jugadores y desarrolladores. ¬°Explora, aprende y crea con nosotros!</p>
        </div>
        <div class="footer-section">
          <h4>Enlaces R√°pidos</h4>
          <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="comunidad.html">Comunidad</a></li>
            <li><a href="juegos.html">Juegos</a></li>
            <li><a href="editar.html">Crear</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Cont√°ctanos</h4>
          <p>Email: contacto@proyectoalternativo.com</p>
          <p>Tel√©fono: +123 456 789</p>
          <p>S√≠guenos en:</p>
          <div class="social-icons">
            <a href="#"><img src="images/facebook-icon.png" alt="Facebook"></a>
            <a href="#"><img src="images/twitter-icon.png" alt="Twitter"></a>
            <a href="#"><img src="images/instagram-icon.png" alt="Instagram"></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024  CodePlay . Todos los derechos reservados.</p>
      </div>
    </footer>

    <script>
       document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/projects');
        if (!response.ok) {
            throw new Error(`Error en la solicitud: ${response.status}`);
        }

        let projects = await response.json();
        const container = document.getElementById('projects-container');
        container.innerHTML = '';

        function renderProjects() {
            container.innerHTML = '';
            projects.sort((a, b) => b.likes - a.likes); // Ordenar por m√°s likes

            projects.forEach(project => {
                const card = document.createElement('div');
                card.classList.add('project-card');

                const iframe = document.createElement('iframe');
                iframe.srcdoc = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <style>${project.css}</style>
                    </head>
                    <body>
                        ${project.html}
                        <script>${project.js}<\\/script>
                    </body>
                    </html>
                `;
                iframe.width = "100%";
                iframe.height = "200px";
                iframe.style.border = "1px solid #ccc";

                const titleElement = document.createElement('h2');
                titleElement.textContent = project.title || 'Proyecto Sin T√≠tulo';

                const viewButton = document.createElement('button');
                viewButton.classList.add('view-project-button');
                viewButton.textContent = 'Ver Proyecto';
                viewButton.addEventListener('click', () => viewProject(project._id));

                const likeButton = document.createElement('button');
                likeButton.classList.add('heart-button');
                likeButton.textContent = `‚ù§Ô∏è ${project.likes || 0}`;

                likeButton.addEventListener('click', async () => {
                    try {
                        const response = await fetch(`/api/projects/${project._id}/like`, { method: 'POST', credentials: 'include' });
                        if (!response.ok) throw new Error('Error al actualizar like');
                        const data = await response.json();
                        project.likes = data.likes;
                        likeButton.textContent = data.liked ? `‚ù§Ô∏è ${data.likes}` : `ü§ç ${data.likes}`;
                        renderProjects(); // Reordenar los proyectos
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });

                const creatorContainer = document.createElement('div');
                creatorContainer.classList.add('creator-container');

                const creatorName = document.createElement('p');
                creatorName.classList.add('project-creator');
                creatorName.textContent = `Creado por: ${project.userId?.usuario || 'An√≥nimo'}`;

                creatorContainer.appendChild(creatorName);
                creatorContainer.appendChild(likeButton);
                card.appendChild(titleElement);
                card.appendChild(viewButton);
                card.appendChild(iframe);
                card.appendChild(creatorContainer);

                container.appendChild(card);
            });
        }
        renderProjects();
    } catch (error) {
        console.error('Error al cargar los proyectos:', error);
        document.getElementById('projects-container').innerHTML = '<p>Error al cargar los proyectos.</p>';
    }
});

function viewProject(projectId) {
    window.location.href = `/project.html?id=${projectId}`;
}
//usuario
        document.addEventListener('DOMContentLoaded', () => {
      const userMenu = document.getElementById('userMenu'); // Obt√©n el contenedor de los botones

      // Verificar si la cookie de sesi√≥n existe
      fetch('/users/session', { method: 'GET', credentials: 'same-origin' })
          .then(response => response.json())
          .then(data => {
              if (!data.loggedIn) {
                  // Redirige al login si no est√° logueado
                  window.location.href = 'login.html';
              } else {
                  // Reemplaza los botones con el men√∫ de perfil si est√° logueado
                  userMenu.innerHTML = `
                      <div class="profile-menu">
                          <img src="images/profile-icon.png" alt="Perfil" style="cursor: pointer; width: 30px; height: 30px; border-radius: 50%;">
                          <span>Hola, ${data.username}</span>
                          <button onclick="logout()">Cerrar Sesi√≥n</button>
                      </div>
                  `;
              }
          })
          .catch(err => console.error('Error verificando la sesi√≥n:', err));
  });

  function logout() {
      fetch('/users/logout', { method: 'POST', credentials: 'same-origin' })
          .then(() => {
              window.location.reload(); // Recargar la p√°gina despu√©s de cerrar sesi√≥n
          })
          .catch(err => console.error('Error cerrando sesi√≥n:', err));
  }
    </script>
</body>
</html>